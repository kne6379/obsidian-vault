---
created: 2026-02-08
updated: 2026-02-08
tags: [project, backend, ai, llm]
status: active
---

# 문제생성엔진 (QGen)

## 개요

AI 문제 생성과 수동 문제 관리를 모두 지원하는 교육 콘텐츠 플랫폼입니다. 멀티 LLM 프로바이더를 활용하여 국어/영어/수학 교과목별 문항을 대규모로 자동 생성하고, 수동으로 입력된 모의고사 데이터도 동일한 포맷으로 관리합니다. JSON 컴포넌트 기반 데이터 포맷으로 다양한 문제 유형을 유연하게 표현하며, 품질 관리 파이프라인을 통해 교육 콘텐츠를 생산합니다.

**기간**: 2025.07 ~ 2025.11
**역할**: 백엔드 전체 설계 및 구현

---

## 기술 스택

| 분류 | 기술 |
|------|------|
| Framework | NestJS, TypeScript |
| Database | PostgreSQL, TypeORM, pgvector |
| AI/LLM | Gemini API, OpenAI API, Claude API, OpenRouter |
| Image | Gemini Imagen, OpenAI DALL-E |
| TTS | Gemini TTS |
| Storage | Supabase Storage |
| Validation | Zod, class-validator |
| Logging | Winston, Slack Webhook |
| Scheduling | @nestjs/schedule (Cron) |
| Infra | AWS EC2, Docker |

---

## 프로젝트 규모

| 지표 | 수치 |
|------|------|
| Feature 모듈 | 27개 |
| 엔티티 (데이터 모델) | 44개 |
| 서비스 | 30개 |
| 컨트롤러 | 14개 |
| LLM/Batch/Image 프로바이더 | 9개 |
| 에러 코드 | 50개+ |

---

## 아키텍처

### 시스템 구조

```
┌──────────────────────────────────────────────────────────────────┐
│                        QGEN API Server                           │
│                     NestJS + TypeScript                          │
├──────────┬───────────┬──────────────┬───────────┬────────────────┤
│  실시간   │  대규모    │   수동 문항   │  통합 조회 │   지문/이미지   │
│  AI 생성  │  배치 생성  │   관리       │           │   /TTS 생성    │
├──────────┴───────────┴──────────────┴───────────┴────────────────┤
│                     Provider Abstraction Layer                    │
├─────────┬──────────┬──────────┬────────────┬─────────────────────┤
│ Gemini  │ OpenAI   │ Claude   │ OpenRouter │ Gemini TTS          │
│ Provider│ Provider │ Provider │ Provider   │ Provider            │
├─────────┴──────────┴──────────┴────────────┴─────────────────────┤
│  PostgreSQL (TypeORM)  │  Supabase Storage  │  pgvector          │
└────────────────────────┴────────────────────┴────────────────────┘
```

### 적용 패턴

| 패턴 | 적용 |
|------|------|
| Provider Pattern | LLM/Image/Batch 프로바이더 추상화 |
| Staging Table | 배치 결과 임시 저장 → 검증 → 운영 승격 |
| Strategy Pattern | 교과목별 프롬프트/생성 전략 분기 |
| Checksum Dedup | SHA256 해시 기반 중복 문항 제거 |
| Inventory Pattern | ownerId NULL/값 기반 재고/배정 추적 |
| Prompt Versioning | key + version 기반 프롬프트 버전 관리 |

---

## 내가 담당한 기능

### 1. 멀티 프로바이더 LLM 추상화 계층

**Provider Pattern 설계**
- Gemini, OpenAI, Claude, OpenRouter 4개 LLM 프로바이더 통합 인터페이스 추상화
- 실시간 생성(단건)과 Batch API(대량) 모두 지원하는 이중 프로바이더 구조

**응답 검증 파이프라인**
- Zod 스키마 기반 LLM 응답 검증
- JSON 파싱, LaTeX 이스케이프 처리, 코드블록 추출 등 후처리
- 프로바이더별 Structured Output 활용으로 파싱 실패율 최소화

### 2. 대규모 배치 문항 생성 파이프라인

**JSONL 기반 Batch Processing**
- 수백~수천 건의 문항을 단일 배치로 처리하는 아키텍처 설계
- 3단계 파이프라인: **빌드(JSONL 구성) → 제출(프로바이더 API) → 결과 파싱(스테이징)**

**Staging Table 패턴**
- 배치 결과를 임시 테이블에 파싱 후 검증을 거쳐 운영 테이블로 승격

**자동화 및 추적**
- Cron 기반 자동 스케줄링 (일일 배치 실행 + 10분 간격 상태 폴링)
- 배치 작업별 비용 추적 (토큰 사용량, USD 비용) 및 소요시간 계산

### 3. 지능형 문항 세트 선정 알고리즘

- 카테고리별 라운드 로빈 분배로 교과목 균형 확보
- 최소 사용 키워드 우선 선택(Least-Used First) 전략으로 키워드 커버리지 극대화
- 세트 완성도 보장: 하나의 키워드가 모든 관련 문제 유형에 사용되도록 패킹 알고리즘 적용
- 키워드 분포 통계 API 제공

### 4. 교과목별 문항 데이터 모델링

**계층 구조 설계**
- 국어/영어/수학 3개 교과, 6개 세부 영역, 학년별(1~3학년) 계층적 교과목 체계
- 문항 구조: SetQuestion → Question 다단계 관계 (세트형 문항 지원)
- 44개 엔티티 설계

**데이터 품질 관리**
- SHA256 체크섬 기반 중복 문항 제거
- pgvector 임베딩(1536차원) 기반 유사 문항 검색
- ComponentBlock 기반 유연한 콘텐츠 구조 (텍스트, 이미지, 테이블, 리스트 등 JSONB 저장)

**재고 관리**
- ownerId NULL(재고) / 값(배정) 패턴으로 문항 할당 추적

### 5. 멀티미디어 콘텐츠 생성

**AI 이미지 생성**
- Gemini Imagen / OpenAI DALL-E 듀얼 프로바이더로 문항 삽화 자동 생성
- 이미지 업로드 API

**Vision Coordinate**
- Claude를 활용한 이미지 내 객체 바운딩 박스 좌표 자동 추출

**TTS 음성 합성**
- Gemini TTS로 듣기 평가 문항의 음성 자동 생성 (남/여 화자 구분)

**파일 관리**
- Supabase Storage 기반 (이미지, 오디오, JSONL 배치 파일)

### 6. 운영 안정성 및 관측성

**로깅 및 알림**
- Winston + Morgan 통합 로깅
- Slack Webhook 알림 연동

**에러 처리**
- 50개 이상의 도메인별 에러 코드 체계
- BusinessException 패턴
- 실패 재시도 큐(RetryQueue) 및 에러 아카이브 구현

**품질 관리**
- QC 상태(PENDING → APPROVED/REJECTED) 기반 문항 품질 워크플로우

### 7. 프롬프트 개발 방법론

**검증 LLM 우선 개발**
- 문제 생성 프롬프트 개발 전, 검증(Judge) LLM을 먼저 구축
- 검증 LLM의 감별 능력을 먼저 확보한 뒤, 이를 통해 생성 프롬프트 품질을 측정

**검증 LLM 감별률 측정**
- 측정 항목(정확도, 해설 일관성 등)에 따라 의도적으로 조작한 오류 데이터 생성
- 정상 데이터셋과 조작 데이터셋을 준비하여 검증 LLM의 감별률 측정
- 감별률 기반으로 검증 LLM 프롬프트 튜닝

**생성 프롬프트 개발**
- 검증 LLM을 통해 생성된 문제의 품질을 자동 평가
- 평가 결과 기반으로 생성 프롬프트 반복 개선

### 8. JSON 컴포넌트 기반 데이터 포맷 설계

**데이터 포맷 설계 배경**
- 국영수 과목별로 다양한 문제 유형(객관식, 주관식, 듣기, 도표, 지문형 등)을 표현해야 함
- 고정된 스키마로는 과목/유형별 특수 요구사항을 수용하기 어려움
- JSON 컴포넌트 형식으로 데이터 포맷을 정의하여 유연성 확보

**ComponentBlock 구조**
- 텍스트, 이미지, 테이블, 리스트, 수식 등을 자유롭게 조합 가능한 JSONB 기반 구조
- 문제에 포함되는 내용들이 순서와 유형에 제약 없이 속할 수 있도록 설계
- 표/차트 타입 컴포넌트로 수학, 사회탐구 등 시각 자료 표현

**데이터 구축 및 정합성 검사**
- 모의고사 원본 데이터를 JSON 컴포넌트 형식으로 변환하는 파이프라인 구축
- 스크립트 기반 정합성 검사: 문제 번호, 정답, 배점, 필수 필드 누락 등 자동 검증
- AI 기반 품질 검사: 맞춤법, 형식 일관성, 내용 오류 등 LLM으로 검사
- 수동 생성 문제와 AI 생성 문제 모두 동일한 포맷으로 통합 관리
- 원본 데이터 관리 체계 구축

### 9. 개발 환경 구축

- NestJS 프로젝트 초기 설정
- Winston 로그 모듈 구현
- Slack 로그 연동
- 전역 에러 처리
- API 명세서 작성 (Swagger/OpenAPI)
- Docker 컨테이너화
- Husky 컨벤션 설정

---

## 성과

- **멀티 LLM 프로바이더 통합 아키텍처** 설계로 Provider 교체 및 확장 용이성 확보
- **JSONL 기반 배치 파이프라인**으로 대규모 문항 생성 자동화
- **44개 엔티티, 27개 모듈** 규모의 모듈화된 아키텍처 설계
- 모듈화된 아키텍처로 유지보수성 향상
- 전체 교육 콘텐츠 파이프라인 구현 (지문 → 문제 → 이미지 → TTS)
- 배치 비용/토큰 추적 시스템으로 운영 비용 투명화

---

## 배운 점

- Provider 패턴을 통한 외부 서비스 추상화의 중요성
- 대규모 배치 처리 시 Staging Table 패턴의 유용성
- LLM 응답의 불확실성을 다루는 방법 (Zod 검증, 후처리 파이프라인)

---

## 관련 문서

- [[RAG 시스템]] - 문제 평가 및 품질 관리
- [[똑스]] - 문제 풀이 플랫폼
- [[Batch Processing]] - 배치 처리 시퀀스 다이어그램
