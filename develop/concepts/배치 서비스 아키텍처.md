---
created: 2026-02-05
updated: 2026-02-05
tags: [concept, backend, design, architecture]
status: done
---

# 배치 서비스 아키텍처

> 배치 문제 생성 시스템의 역할 분리와 벌크 처리 최적화를 위한 아키텍처 설계입니다.

---

## 1. 배경

### 1.1 현재 상황

- NestJS → Python 마이그레이션 진행 중
- 기존 `BatchService`에 너무 많은 책임이 혼재
- 실시간/배치 간 코드 재사용 어려움

### 1.2 목표

| 목표 | 설명 |
|------|------|
| **역할 분리** | 각 도메인이 명확한 책임만 가짐 |
| **벌크 처리** | N개 요청 → 소수의 쿼리로 최적화 |
| **범용성** | QC, 이미지 생성 등 다른 배치 작업에서도 재사용 |

---

## 2. 도메인 역할 분리

### 2.1 역할 판단 기준

| 질문 | 답변 기준 |
|------|----------|
| 배치 전용인가, 실시간에서도 사용되는가? | 배치 전용 → `batch`, 공용 → `generation/shared` |
| 특정 도메인 전용인가, 범용인가? | 전용 → 해당 도메인, 범용 → `shared` |
| 외부 데이터 조회를 포함하는가? | 종속 조회 → 해당 도메인, 순수 변환 → `shared` |

### 2.2 도메인별 책임

```
batch (BatchRequestService)
├── 키워드 + 문제유형 선정 (배치 전용)
├── JSONL 빌드/업로드
├── Provider 제출 (submit)
├── 상태 폴링 (polling)
└── 결과 다운로드 (download)

generation (GenerationQuestionService)
├── 문제 생성 컨텍스트 조회 (예제문제, 문제유형, 과목)
└── 생성된 문제 저장

shared
├── SharedPromptService: 프롬프트 빌드 (템플릿 + 변수 치환)
└── SharedParserService: LLM 응답 파싱/검증
```

### 2.3 역할 분리 근거

**SharedPromptService가 순수 빌드만 담당하는 이유**
- 어떤 도메인이든 사용 가능한 범용 유틸리티
- 프롬프트 템플릿 조회 + 변수 치환만 수행
- 종속된 데이터 조회 로직 없음 (변수는 외부에서 전달)

**GenerationQuestionService가 컨텍스트 조회를 담당하는 이유**
- "문제 생성을 위한 컨텍스트"는 문제 생성 전용
- 예제문제, 문제유형, 과목 정보는 QC/임베딩에서 불필요
- 실시간 생성에서도 동일한 컨텍스트 필요 → 재사용 가능

**키워드 선정이 batch에 있는 이유**
- 배치 작업 전용 로직 (실시간에서는 사용자가 키워드 직접 입력)
- QC/이미지 배치에서는 사용 안 함

---

## 3. 배치 처리 흐름

### 3.1 10단계 파이프라인

```
┌─────────────────────────────────────────────────────────────┐
│                        빌드 단계                             │
├─────────────────────────────────────────────────────────────┤
│ 1. 키워드 매칭 (batch)      → 문제유형 + 키워드 조합 선정      │
│ 2. 메타데이터 세팅 (generation) → 예제문제, 과목 등 컨텍스트    │
│ 3. 프롬프트 빌드 (shared)    → 템플릿 + 변수 → 최종 프롬프트   │
│ 4. JSONL 빌드 (batch)       → Provider 형식으로 변환         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        전송 단계                             │
├─────────────────────────────────────────────────────────────┤
│ 5. Storage Upload (batch)   → GCS에 JSONL 업로드            │
│ 6. Submit (batch)           → Provider에 배치 작업 제출      │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        수신 단계                             │
├─────────────────────────────────────────────────────────────┤
│ 7. Polling (batch)          → 작업 완료 여부 확인            │
│ 8. Download (batch)         → 결과 JSONL 다운로드            │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                        후처리 단계                           │
├─────────────────────────────────────────────────────────────┤
│ 9. Parse (shared)           → LLM 응답 파싱/검증             │
│ 10. Save (generation)       → 검증된 문제 DB 저장            │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 단계별 담당 도메인

| 단계 | 담당 | 메서드 |
|------|------|--------|
| 1. 키워드 매칭 | batch | `select_batch_items()` |
| 2. 메타데이터 | generation | `get_generation_contexts_bulk()` |
| 3. 프롬프트 빌드 | shared | `build_bulk()` |
| 4. JSONL 빌드 | batch | `build_jsonl()` |
| 5-8. 전송/수신 | batch | `submit()`, `poll()`, `download()` |
| 9. 파싱 | shared | `parse_batch()` |
| 10. 저장 | generation | `save_generated_questions_bulk()` |

---

## 4. 벌크 처리 전략

### 4.1 문제점: 단건 처리의 비효율

```
현재 (단건 처리):
100개 요청
  → 100번 QuestionType 조회
  → 100번 Subject 조회
  → 100번 ExampleQuestion 조회
  = 300개 쿼리
```

### 4.2 해결: 벌크 조회 + 인메모리 캐싱

```
개선 (벌크 처리):
100개 요청
  → 1번 QuestionType 벌크 조회
  → 1번 Subject 조회
  → 1번 ExampleQuestion 벌크 조회
  = 3개 쿼리

+ 인메모리 캐싱:
  - 캐시 키: (question_type_id, grade)
  - 같은 조합이 반복되면 캐시에서 반환
```

### 4.3 벌크 메서드 추가 대상

| Service | 메서드 | 설명 |
|---------|--------|------|
| GenerationQuestionService | `get_generation_contexts_bulk()` | 컨텍스트 벌크 조회 |
| GenerationQuestionService | `save_generated_questions_bulk()` | 결과 벌크 저장 |
| SharedPromptService | `build_bulk()` | 프롬프트 벌크 빌드 |

> `SharedParserService.parse_batch()`는 이미 벌크 지원

---

## 5. 네이밍 컨벤션

### 5.1 Service 네이밍 규칙

```
{domain}_{target}_service.py → {Domain}{Target}Service
```

| 파일명 | 클래스명 |
|--------|----------|
| `batch_request_service.py` | `BatchRequestService` |
| `generation_question_service.py` | `GenerationQuestionService` |
| `shared_prompt_service.py` | `SharedPromptService` |

### 5.2 변경 사항

- `batch_service.py` → `batch_request_service.py` (네이밍 컨벤션 준수)
- `batch_setting_service.py` → **삭제** (AWS EventBridge로 대체)

---

## 6. 구현 계획

### 6.1 신규 생성

| 파일 | 설명 |
|------|------|
| `app/infrastructure/persistence/batch/keyword_repository.py` | 키워드 조회 |
| `app/infrastructure/persistence/batch/keyword_usage_repository.py` | 사용 이력 |

### 6.2 수정

| 파일 | 변경 내용 |
|------|----------|
| `batch_service.py` → `batch_request_service.py` | 리네이밍 + `select_batch_items()`, `build_jsonl()` 추가 |
| `example_question_repository.py` | `find_by_question_type_ids()` 추가 |
| `generation_question_service.py` | `get_generation_contexts_bulk()`, `save_generated_questions_bulk()` 추가 |
| `shared_prompt_service.py` | `build_bulk()` 추가 |

### 6.3 삭제

| 파일 | 사유 |
|------|------|
| `batch_setting_service.py` | AWS EventBridge + Step Functions로 대체 |

---

## 7. 구현 순서

```
Step 1: 키워드 매칭 (Repository → Service)
    ↓
Step 2: 메타데이터 벌크 조회 (Repository → Service)
    ↓
Step 3: 프롬프트 벌크 빌드
    ↓
Step 4: JSONL 빌드 분리
    ↓
Step 10: 벌크 저장
    ↓
UseCase 통합: 전체 흐름 연결
```

---

## 8. 검증 계획

```bash
# 키워드 선정 테스트
uv run pytest tests/domain/batch/ -k "selection"

# 벌크 메서드 테스트
uv run pytest tests/domain/generation/ -k "bulk"
uv run pytest tests/domain/shared/ -k "bulk"

# Lint
uv run ruff check . --fix && uv run ruff format .
```

---

## 9. 프로젝트 구조

```
app/
├── domain/
│   ├── batch/
│   │   ├── batch_request_service.py      ← 배치 전용 로직
│   │   └── strategies/
│   │       └── selection_strategy.py     ← 키워드 선정 전략
│   ├── generation/
│   │   └── generation_question_service.py ← 문제 생성 컨텍스트/저장
│   └── shared/
│       ├── shared_prompt_service.py      ← 프롬프트 빌드
│       └── shared_parser_service.py      ← 응답 파싱
│
├── infrastructure/
│   ├── ai/batch/
│   │   ├── base_batch_provider.py        ← Provider 추상
│   │   └── gemini_batch_provider.py      ← Gemini 구현
│   └── persistence/batch/
│       ├── keyword_repository.py         ← 키워드 조회
│       └── keyword_usage_repository.py   ← 사용 이력
│
└── core/
    └── dependencies.py                   ← Factory 함수들
```

---

## 관련 문서

- [[디자인 패턴 비교]] - Provider, Strategy, Factory 패턴 비교
- [[SOLID]] - 객체지향 설계 5원칙

---

## 참고 자료

- [AWS Step Functions](https://docs.aws.amazon.com/step-functions/) - 배치 워크플로우 오케스트레이션
- [Google Cloud Batch](https://cloud.google.com/batch) - GCP 배치 처리
